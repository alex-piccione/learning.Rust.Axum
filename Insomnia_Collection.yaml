type: collection.insomnia.rest/5.0
name: Main
meta:
  id: wrk_e85e575ef83d4eb3b2f07d538efeef8a
  created: 1755294938718
  modified: 1757418637533
  description: ""
collection:
  - name: with Authentication
    meta:
      id: fld_75a8735663df4c6c9164cc49996a1a21
      created: 1760017656052
      modified: 1760029934433
      sortKey: -1760017656052
      description: ""
    children:
      - name: Custodian
        meta:
          id: fld_37fba565854c4ed3a3d9c395d066229a
          created: 1756737042672
          modified: 1760017675555
          sortKey: -1760017663221
          description: ""
        children:
          - url: "{{ _.url }}/custodian"
            name: /custodian (List)
            meta:
              id: req_5ebc8c52f4c14235a0337ab687be860e
              created: 1756737047710
              modified: 1756737204173
              isPrivate: false
              description: ""
              sortKey: -1756737047710
            method: GET
            headers:
              - name: User-Agent
                value: insomnia/11.5.0
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
          - url: "{{ _.url }}/custodian"
            name: /custodian (Create)
            meta:
              id: req_c374f205da2c4ab6a2f09ae3afb7192e
              created: 1756764131003
              modified: 1757418846712
              isPrivate: false
              description: ""
              sortKey: -1756737047810
            method: POST
            body:
              mimeType: application/json
              text: |-
                {
                	"name": "Fineco",
                	"kind": "Bank",
                	"description": "Italian bank account",
                	"url": "https://fineco.it",
                	"wallet_address": null,
                	"account_country_code": "IT"
                }
            headers:
              - name: Content-Type
                value: application/json
              - name: User-Agent
                value: insomnia/11.5.0
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
          - url: "{{ _.url }}/custodian"
            name: /custodian (Update)
            meta:
              id: req_fc1e1d4bde324c81ac2701bc56c41f93
              created: 1757323917993
              modified: 1757324460216
              isPrivate: false
              description: ""
              sortKey: -1756737047760
            method: PUT
            body:
              mimeType: application/json
              text: |-
                {
                	"id": 3,
                	"name": "Nexo",
                	"kind": "Fintech Platform",
                	"description": "Cryptodurrency platform",
                	"url": "https://nexo.com",
                	"wallet_address": null,
                	"country_code": "IT"
                }
            headers:
              - name: Content-Type
                value: application/json
              - name: User-Agent
                value: insomnia/11.5.0
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
      - name: Currency
        meta:
          id: fld_7e7d4578e0154c9188ce203dc89f2166
          created: 1756737093987
          modified: 1760029934433
          sortKey: -1760017663321
          description: ""
        children:
          - url: "{{ _.url }}/currency/123"
            name: /currency/{id} (Single)
            meta:
              id: req_a0d8ffc90345461a916aa1bbe24c0d4e
              created: 1755295289332
              modified: 1756737175716
              isPrivate: false
              description: ""
              sortKey: -1756737103977
            method: GET
            headers:
              - name: User-Agent
                value: insomnia/11.4.0
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
          - url: "{{ _.url }}/currency"
            name: /currency (List)
            meta:
              id: req_3bb621e55a354831a0d7750084e3e4a9
              created: 1755296835097
              modified: 1756737181404
              isPrivate: false
              description: ""
              sortKey: -1756737103877
            method: GET
            headers:
              - name: User-Agent
                value: insomnia/11.4.0
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
          - url: "{{ _.url }}/currency"
            name: /currency (Create)
            meta:
              id: req_fb0aa59debd148bcad48bbcaf489b9aa
              created: 1755296976015
              modified: 1756737170889
              isPrivate: false
              description: ""
              sortKey: -1756737104077
            method: POST
            body:
              mimeType: application/json
              text: |-
                {
                	"symbol": "GBP",
                	"name": "Pound",
                	"kind": "Fiat",
                	"is_active": true,
                	"precision": 2
                }
            headers:
              - name: Content-Type
                value: application/json
              - name: User-Agent
                value: insomnia/11.4.0
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
          - url: "{{ _.url }}/currency"
            name: /currency (Update)
            meta:
              id: req_e4df2afafa304ebf85b5979f2f81350a
              created: 1756732326032
              modified: 1756737187608
              isPrivate: false
              description: ""
              sortKey: -1756737103777
            method: PUT
            body:
              mimeType: application/json
              text: |-
                {
                	"id": 1,
                	"symbol": "XRD",
                	"name": "Radix",
                	"kind": "Crypto",
                	"is_active": true,
                	"precision": 18
                }
            headers:
              - name: Content-Type
                value: application/json
              - name: User-Agent
                value: insomnia/11.4.0
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
    scripts:
      preRequest: "// Update the access_token in the Bae Environment (Collection
        environment)

        //const moment = require(\"moment\")


        const logInfo = text => console.info(\">>>>> \" + text)

        const logWarn = text => console.warn(\">>>>> \" + text)

        const logError = text => console.error(\">>>>> \" + text)


        const accessToken = insomnia.baseEnvironment.get(\"accessToken\")

        const refreshToken = insomnia.baseEnvironment.get(\"refreshToken\")

        const accessTokenExpiresAtString =
        insomnia.baseEnvironment.get(\"accessTokenExpiresAt\")

        const refreshTokenExpiresAtString =
        insomnia.baseEnvironment.get(\"refreshTokenExpiresAt\")


        //if (moment(authTokenExpiresAt) < moment()) {

        if (new Date(accessTokenExpiresAtString) < Date.now()) {

        \tlogInfo(`Access Token is expired ${accessTokenExpiresAtString}.`)

        \t

        \tif (new Date(refreshTokenExpiresAtString) < Date.now()) {

        \t\tlogInfo(`Refresh Token is expired ${refreshTokenExpiresAtString}.`)

        \t\tlogWarn(\"Access and refresh tokens both expired. You need to login
        again !\")

        \t\treturn;

        \t}

        \t

        \tlogInfo(\"Call /refresh-token\")

        \t

        \tconst apiUrl = insomnia.environment.get(\"url\")\t

        \  const url = apiUrl + \"/refresh-token\"

        \tlogInfo(`url: ${url}`)

        \t

        \tawait insomnia.sendRequest(

        \t\t{

        \t\t\turl: url,

        \t\t\tmethod: \"POST\",

        \t\t\theader: { \"Content-Type\": \"application/json\"},

        \t\t\tbody: {

        \t\t\t\tmode: \"raw\",

        \t\t\t\traw: JSON.stringify( { refreshToken: refreshToken })

        \t\t\t}

        \t\t},

        \t\t(error, response) => {

        \t\t\tif (error) { logError(`Refresh token failed. ${error}`) }

        \t\t\telse {\ 

        \t\t\t\t

        \t\t\t\tif (response.code == 200) {

        \t\t\t\t\tconst jsonBody = response.json();

        \t\t\t\t\tconst new_accessToken = jsonBody.accessToken

        \t\t\t\t\tconst new_refreshToken = jsonBody.refreshToken

        \t\t\t\t\tconst new_accessTokenExpiresAtString =
        jsonBody.accessTokenExpiresAt

        \t\t\t\t\tconst new_refreshTokenExpiresAtString =
        jsonBody.refreshTokenExpiresAt

        \t

        \t\t\t\t\tif (new_accessToken && new_refreshToken &&
        new_accessTokenExpiresAtString && new_refreshTokenExpiresAtString) {

        \t\t\t\t\t\tlogInfo(`Set Base Environment Access and Refresh tokens with
        new values: ${new_accessToken} and ${new_refreshToken}`)

        \t\t\t\t\t\tinsomnia.baseEnvironment.set(\"accessToken\",
        new_accessToken)\t\t\t\t\t\t

        \t\t\t\t\t\tinsomnia.baseEnvironment.set(\"refreshToken\",
        new_refreshToken)\t\t\t\t\t\t

        \t\t\t\t\t\tinsomnia.baseEnvironment.set(\"accessTokenExpiresAt\",
        new_accessTokenExpiresAtString)

        \t\t\t\t\t\tinsomnia.baseEnvironment.set(\"refreshTokenExpiresAt\",
        new_refreshTokenExpiresAtString)

        \t\t\t\t\t}\telse {

        \t\t\t\t\t\tlogError(\"Some property is undefined or not found in the
        JSON response\")

        \t\t\t\t\t\tlogInfo(`response: ${response}`)

        \t\t\t\t\t}

        \t\t\t\t}\t\t\t

        \t\t\t\t

        \t\t\t}

        \t\t})\t\t

        }

        else {

        \tlogInfo(\"The access token is NOT expired. OK.\")

        }

        \t"
    authentication:
      type: none
    headers:
      - id: pair_f4cc659ca68c42459817afdc9b2f55a1
        name: X-Auth-Token
        value: "{{ _.accessToken }}"
        description: ""
        disabled: false
  - name: anonymous calls
    meta:
      id: fld_2e9b0fe89d7a49db8fcf58030fd8ae95
      created: 1760017700058
      modified: 1760028467780
      sortKey: -1760017700058
      description: ""
    children:
      - url: "{{ _.url }}/"
        name: home
        meta:
          id: req_b9f230d9923f414d9baac3bc51de0215
          created: 1755294938898
          modified: 1760017719895
          isPrivate: false
          description: ""
          sortKey: -1760017712490
        method: GET
        parameters:
          - id: pair_06e0ce4df1174e14bd530feaa29e91ab
            name: ""
            value: ""
            description: ""
            disabled: false
        headers:
          - name: User-Agent
            value: insomnia/11.4.0
        settings:
          renderRequestBody: true
          encodeUrl: true
          followRedirects: global
          cookies:
            send: true
            store: true
          rebuildPath: true
      - name: Auth
        meta:
          id: fld_84fc3822e5ef45c19bb481187a6460c6
          created: 1759332730257
          modified: 1760028467781
          sortKey: -1760017712390
          description: ""
        children:
          - url: "{{ _.url }}/login"
            name: /login
            meta:
              id: req_f299cc90d90943e482c866079202d60a
              created: 1759332736647
              modified: 1760028366650
              isPrivate: false
              description: ""
              sortKey: -1759332736647
            method: POST
            body:
              mimeType: application/json
              text: |-
                {
                	"username": "demo-1",
                	"password": "demo-1"
                }
            headers:
              - name: Content-Type
                value: application/json
              - name: User-Agent
                value: insomnia/11.6.1
            scripts:
              afterResponse: >
                // Set the base Environment variables for authentication

                const moment = require("moment")


                const logInfo = text => console.info(">>>>> LOG " + text)

                const logWarn = text => console.warn(">>>>> LOG " + text)

                const logError = text => console.error(">>>>> LOG " + text)


                // get the token

                if (insomnia.response.code == 200) {
                	const jsonBody = insomnia.response.json();
                  const accessToken = jsonBody.accessToken
                	const refreshToken = jsonBody.refreshToken
                	const accessTokenExpiresAtString = jsonBody.accessTokenExpiresAt
                	const refreshTokenExpiresAtString = jsonBody.refreshTokenExpiresAt
                	const expiresAt = moment(accessTokenExpiresAtString)
                	
                	if (accessToken && refreshToken && accessTokenExpiresAtString && refreshTokenExpiresAtString) {
                		logInfo(`Set Base Environment variables with new token: ${accessToken} and ${refreshToken}`)
                		insomnia.baseEnvironment.set("accessToken", accessToken)		
                		insomnia.baseEnvironment.set("refreshToken", refreshToken)
                		insomnia.baseEnvironment.set("accessTokenTxpiresAt", accessTokenExpiresAtString)
                		insomnia.baseEnvironment.set("refreshTokenTxpiresAt", refreshTokenExpiresAtString)
                	}	else {
                		logError("some properties are undefined in the JSON response")
                		logInfo(`response: ${insomnia.response}`)
                	}
                }
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
          - url: "{{ _.url }}/signup"
            name: /signup
            meta:
              id: req_081f51b09d684716a5a6739f8ea888fb
              created: 1759415965915
              modified: 1760028489221
              isPrivate: false
              description: ""
              sortKey: -1758376094211
            method: POST
            body:
              mimeType: application/json
              text: |-
                {
                	"username": "demo-1",
                	"password": "demo-1",
                	"currencyId": 1
                }
            headers:
              - name: Content-Type
                value: application/json
              - name: User-Agent
                value: insomnia/11.6.1
            settings:
              renderRequestBody: true
              encodeUrl: true
              followRedirects: global
              cookies:
                send: true
                store: true
              rebuildPath: true
cookieJar:
  name: Default Jar
  meta:
    id: jar_f322ba964e83a6cb0018749707cbaf634cb9e10a
    created: 1755294938724
    modified: 1760029934423
environments:
  name: Base Environment
  meta:
    id: env_f322ba964e83a6cb0018749707cbaf634cb9e10a
    created: 1755294938721
    modified: 1760029934428
    isPrivate: false
  data:
    accessToken: armG2RgdFEGvDrBiBXn2nRo27AlHllgDa1QIhydWlpLWQiTFqJ6iOZFxTIQn8yiy
    refreshToken: iCzC8ZxVDVWOtgAn4eTYtpzoAdECTwbsaIPZYY6JOAFoke4O6Qjq0IdX6Smj4rSc
    accessTokenTxpiresAt: 2025-10-09T17:17:47.729239900Z
    refreshTokenTxpiresAt: 2025-11-08T16:47:47.729239900Z
